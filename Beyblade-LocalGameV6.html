<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyblade Burst - Official App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Arial', sans-serif;
            background: #000;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, #ff6b00 0%, #ff0000 100%);
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #ffff00;
        }

        .app-header h1 {
            color: white;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .app-content {
            flex: 1;
            overflow: auto;
            background: #111;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            animation: slideIn 0.3s;
        }

        .screen.active {
            display: flex;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* ===== MENU SCREEN ===== */
        .menu-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            gap: 20px;
        }

        .menu-logo {
            font-size: 4em;
            text-align: center;
        }

        .menu-title {
            color: #ffff00;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            font-weight: bold;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 400px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #ff6b00 0%, #ff0000 100%);
            color: white;
            border: 3px solid #ffff00;
            padding: 20px;
            font-size: 1.3em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 100, 0, 0.4);
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 100, 0, 0.8);
        }

        /* ===== BLADER SETUP SCREEN ===== */
        .setup-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
        }

        .setup-title {
            color: #ffff00;
            font-size: 2em;
            text-align: center;
        }

        .blader-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 90%;
            max-width: 500px;
        }

        .blader-input-group {
            text-align: center;
        }

        .blader-input-label {
            color: #ff6b00;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .blader-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 100, 0, 0.2);
            border: 2px solid #ff6b00;
            border-radius: 8px;
            color: white;
            font-size: 1em;
        }

        .blader-input::placeholder {
            color: #888;
        }

        /* ===== BEYBLADE SELECTION ===== */
        .selection-screen {
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .selection-title {
            color: #ffff00;
            font-size: 1.8em;
            text-align: center;
        }

        .bey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            width: 100%;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .bey-option {
            background: rgba(255, 100, 0, 0.1);
            border: 3px solid #ff6b00;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .bey-option:hover {
            border-color: #ffff00;
            box-shadow: 0 0 20px rgba(255, 100, 0, 0.6);
        }

        .bey-option.selected {
            border-color: #00ff00;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
            background: rgba(0, 255, 0, 0.1);
        }

        .bey-canvas {
            width: 80px;
            height: 80px;
            margin: 5px auto;
            border: 1px solid #555;
            background: #222;
        }

        .bey-label {
            font-weight: bold;
            color: #ffff00;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* ===== BATTLE SCREEN ===== */
        .battle-screen {
            flex-direction: column;
            background: #000;
            padding: 0;
        }

        .battle-header {
            background: #1a1a2e;
            padding: 15px;
            border-bottom: 2px solid #ff6b00;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-header {
            text-align: center;
            color: white;
        }

        .player-name {
            color: #ffff00;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .player-bey-name {
            color: #ff6b00;
            font-size: 0.85em;
        }

        .battle-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
        }

        .launcher-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .launcher-box {
            background: rgba(255, 100, 0, 0.1);
            border: 2px solid #ff6b00;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .launcher-canvas {
            width: 100px;
            height: 100px;
            margin: 10px auto;
            border: 2px solid #555;
            background: #222;
            border-radius: 5px;
        }

        .launcher-btn {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: #000;
            border: 2px solid #ffff00;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .launcher-btn:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }

        .launcher-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .launcher-status {
            color: #aaa;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .stadium-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #battleStadium {
            border: 4px solid #ff6b00;
            border-radius: 50%;
            background: radial-gradient(circle at center, #333 0%, #111 70%, #000 100%);
            box-shadow: 0 0 30px rgba(255, 100, 0, 0.4);
        }

        .countdown-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }

        .countdown-num {
            font-size: 5em;
            color: #ffff00;
            font-weight: bold;
            text-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
            animation: countdownBounce 1s;
        }

        @keyframes countdownBounce {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .status-bars {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .status-panel {
            background: rgba(255, 100, 0, 0.1);
            border: 2px solid #ff6b00;
            border-radius: 8px;
            padding: 12px;
        }

        .status-label {
            color: #ff6b00;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .hp-bar, .stamina-bar {
            height: 20px;
            background: #333;
            border: 1px solid #ff6b00;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .hp-fill, .stamina-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            padding: 0 5px;
            color: #000;
            font-size: 0.7em;
            font-weight: bold;
        }

        .stamina-fill {
            background: linear-gradient(90deg, #0080ff, #00ffff);
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ff0000, #ff6b00);
        }

        .stat-text {
            color: #aaa;
            font-size: 0.75em;
            margin-bottom: 8px;
        }

        .burst-counter {
            text-align: center;
            margin-top: 8px;
        }

        .burst-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #ff6b00;
            border-radius: 3px;
            margin: 0 3px;
            border: 1px solid #ffff00;
        }

        .burst-icon.blocked {
            background: #00ff00;
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b00;
            border-radius: 8px;
            padding: 12px;
            height: 150px;
            overflow-y: auto;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            margin: 10px 0;
        }

        .log-line {
            margin: 3px 0;
            padding-bottom: 2px;
        }

        .log-collision {
            color: #ff6b6b;
        }

        .log-burst {
            color: #ff00ff;
            font-weight: bold;
        }

        .log-system {
            color: #00ffff;
        }

        /* ===== END SCREEN ===== */
        .end-screen {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            gap: 30px;
        }

        .end-title {
            color: #ffff00;
            font-size: 3em;
            text-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
        }

        .end-message {
            color: #ff6b00;
            font-size: 1.3em;
            text-align: center;
        }

        .end-buttons {
            display: flex;
            gap: 15px;
        }

        .end-btn {
            background: linear-gradient(135deg, #ff6b00 0%, #ff0000 100%);
            color: white;
            border: 2px solid #ffff00;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }

        .end-btn:hover {
            box-shadow: 0 0 20px rgba(255, 100, 0, 0.8);
        }

        .scrollable {
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff6b00;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffff00;
        }

        .vs-text {
            color: #ffff00;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>üî• BEYBLADE BURST üî•</h1>
        </div>

        <div class="app-content">
            <!-- MENU SCREEN -->
            <div class="screen active menu-screen" id="menuScreen">
                <div class="menu-logo">üéÆ</div>
                <h2 class="menu-title">BEYBLADE BURST</h2>
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="app.startPvp()">‚öîÔ∏è PVP BATTLE</button>
                    <button class="menu-btn" onclick="app.startStory()">üìñ STORY MODE</button>
                    <button class="menu-btn" onclick="app.startTraining()">üéØ TRAINING</button>
                </div>
            </div>

            <!-- BLADER SETUP -->
            <div class="screen setup-screen" id="setupScreen">
                <h2 class="setup-title">ENTER BLADER INFO</h2>
                <div class="blader-inputs">
                    <div class="blader-input-group">
                        <label class="blader-input-label">BLADER 1</label>
                        <input type="text" class="blader-input" id="blader1Name" placeholder="Blader Name" maxlength="15">
                    </div>
                    <div class="blader-input-group">
                        <label class="blader-input-label">BLADER 2</label>
                        <input type="text" class="blader-input" id="blader2Name" placeholder="Blader Name" maxlength="15">
                    </div>
                </div>
                <div class="menu-buttons" style="width: 90%; max-width: 400px;">
                    <button class="menu-btn" onclick="app.goToSelection()">CONTINUE</button>
                    <button class="menu-btn" onclick="app.showScreen('menuScreen')" style="background: #666;">BACK</button>
                </div>
            </div>

            <!-- BEYBLADE SELECTION -->
            <div class="screen selection-screen" id="selectionScreen">
                <h2 class="selection-title">SELECT BEYBLADES</h2>
                <div class="bey-grid scrollable" id="beyGrid"></div>
                <div class="menu-buttons" style="width: 90%; max-width: 400px; margin: 0 auto 20px;">
                    <button class="menu-btn" id="startBtn" onclick="app.startBattle()" disabled>START BATTLE</button>
                    <button class="menu-btn" onclick="app.showScreen('menuScreen')" style="background: #666;">BACK</button>
                </div>
            </div>

            <!-- BATTLE SCREEN -->
            <div class="screen battle-screen" id="battleScreen">
                <div class="battle-header">
                    <div class="player-header">
                        <div class="player-name" id="p1Name"></div>
                        <div class="player-bey-name" id="p1BeyName"></div>
                    </div>
                    <div class="player-header">
                        <div class="player-name" id="p2Name"></div>
                        <div class="player-bey-name" id="p2BeyName"></div>
                    </div>
                </div>

                <div class="battle-content scrollable">
                    <div class="launcher-area">
                        <div class="launcher-box">
                            <div style="color: #ff6b00; font-weight: bold; font-size: 0.9em;">LAUNCHER 1</div>
                            <canvas class="launcher-canvas" id="p1LaunchCanvas"></canvas>
                            <button class="launcher-btn" id="p1LaunchBtn" onclick="app.launch(1)">LAUNCH</button>
                            <div class="launcher-status" id="p1LaunchStatus">Ready</div>
                        </div>
                        <div class="launcher-box">
                            <div style="color: #ff6b00; font-weight: bold; font-size: 0.9em;">LAUNCHER 2</div>
                            <canvas class="launcher-canvas" id="p2LaunchCanvas"></canvas>
                            <button class="launcher-btn" id="p2LaunchBtn" onclick="app.launch(2)">LAUNCH</button>
                            <div class="launcher-status" id="p2LaunchStatus">Ready</div>
                        </div>
                    </div>

                    <div class="stadium-container">
                        <canvas id="battleStadium" width="400" height="400"></canvas>
                    </div>

                    <div class="vs-text" id="vsText" style="display: none;">3</div>

                    <div class="status-bars">
                        <div class="status-panel">
                            <div class="status-label">PLAYER 1</div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="p1HpBar" style="width: 100%;">HP</div>
                            </div>
                            <div class="stamina-bar">
                                <div class="stamina-fill" id="p1StaminaBar" style="width: 100%;"></div>
                            </div>
                            <div class="stat-text" id="p1Stats">HP: 100/100 | STA: 100/100</div>
                            <div class="burst-counter">
                                <span style="color: #aaa; font-size: 0.8em;">BURSTS:</span>
                                <span class="burst-icon" id="p1Burst1"></span>
                                <span class="burst-icon" id="p1Burst2"></span>
                                <span class="burst-icon" id="p1Burst3"></span>
                            </div>
                        </div>

                        <div class="status-panel">
                            <div class="status-label">PLAYER 2</div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="p2HpBar" style="width: 100%;">HP</div>
                            </div>
                            <div class="stamina-bar">
                                <div class="stamina-fill" id="p2StaminaBar" style="width: 100%;"></div>
                            </div>
                            <div class="stat-text" id="p2Stats">HP: 100/100 | STA: 100/100</div>
                            <div class="burst-counter">
                                <span style="color: #aaa; font-size: 0.8em;">BURSTS:</span>
                                <span class="burst-icon" id="p2Burst1"></span>
                                <span class="burst-icon" id="p2Burst2"></span>
                                <span class="burst-icon" id="p2Burst3"></span>
                            </div>
                        </div>
                    </div>

                    <div class="battle-log" id="battleLog"></div>
                </div>
            </div>

            <!-- END SCREEN -->
            <div class="screen end-screen" id="endScreen">
                <h1 class="end-title" id="endTitle">VICTORY!</h1>
                <p class="end-message" id="endMessage">Player 1 Wins!</p>
                <div class="end-buttons">
                    <button class="end-btn" onclick="app.showScreen('menuScreen')">MENU</button>
                    <button class="end-btn" onclick="location.reload()">PLAY AGAIN</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== BEYBLADE DESIGNS =====
        function drawBeyblade(ctx, beyType, size = 100) {
            ctx.save();
            ctx.translate(size/2, size/2);

            const designs = {
                spryzen: () => {
                    ctx.fillStyle = '#4a9eff';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#003fb3';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 4; i++) {
                        ctx.save();
                        ctx.rotate((i * Math.PI / 2));
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.bezierCurveTo(10, 7, 15, 12, 20, 25);
                        ctx.stroke();
                        ctx.restore();
                    }

                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, 6, 0, Math.PI * 2);
                    ctx.fill();
                },

                valtrak: () => {
                    ctx.fillStyle = '#8b00ff';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 3; i++) {
                        ctx.save();
                        ctx.rotate((i * Math.PI / 1.5));
                        ctx.beginPath();
                        ctx.moveTo(0, -15);
                        ctx.lineTo(6, 0);
                        ctx.lineTo(0, 10);
                        ctx.stroke();
                        ctx.restore();
                    }

                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, 7, 0, Math.PI * 2);
                    ctx.fill();
                },

                fafnir: () => {
                    ctx.fillStyle = '#cc0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.ellipse(0, -5, 6, 4, 0, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-2, -6, 1.5, 0, Math.PI * 2);
                    ctx.arc(2, -6, 1.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 1.5;
                    for (let i = 0; i < 4; i++) {
                        ctx.save();
                        ctx.rotate((i * Math.PI / 2));
                        ctx.beginPath();
                        ctx.moveTo(0, 25);
                        ctx.lineTo(3, 35);
                        ctx.stroke();
                        ctx.restore();
                    }

                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, 6, 0, Math.PI * 2);
                    ctx.fill();
                },

                phoenix: () => {
                    ctx.fillStyle = '#ff6b00';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#ffff00';
                    for (let i = 0; i < 4; i++) {
                        ctx.save();
                        ctx.rotate((i * Math.PI / 2));
                        ctx.beginPath();
                        ctx.moveTo(0, -25);
                        ctx.bezierCurveTo(6, -20, 10, -10, 6, 0);
                        ctx.bezierCurveTo(0, -5, -6, -20, 0, -25);
                        ctx.fill();
                        ctx.restore();
                    }

                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, 7, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, 4, 0, Math.PI * 2);
                    ctx.fill();
                },

                apocalypse: () => {
                    ctx.fillStyle = '#330033';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2.5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#ff00ff';
                    for (let i = 0; i < 6; i++) {
                        ctx.save();
                        ctx.rotate((i * Math.PI / 3));
                        ctx.beginPath();
                        ctx.moveTo(0, -25);
                        ctx.lineTo(4, -35);
                        ctx.lineTo(-4, -35);
                        ctx.fill();
                        ctx.restore();
                    }

                    ctx.fillStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.arc(-3, -2, 3, 0, Math.PI * 2);
                    ctx.arc(3, -2, 3, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#00ffff';
                    ctx.beginPath();
                    ctx.arc(0, 0, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            };

            if (designs[beyType]) {
                designs[beyType]();
            }

            ctx.restore();
        }

        // ===== BEYBLADES DATA =====
        const BEYBLADES = {
            spryzen: { name: 'Spryzen', type: 'Attack', hp: 100, atk: 9, def: 6, sta: 7, spd: 9 },
            valtrak: { name: 'Valtrak', type: 'Balance', hp: 95, atk: 10, def: 5, sta: 6, spd: 8 },
            fafnir: { name: 'Fafnir', type: 'Stamina', hp: 110, atk: 8, def: 8, sta: 10, spd: 6 },
            phoenix: { name: 'Phoenix', type: 'Balance', hp: 105, atk: 9, def: 7, sta: 8, spd: 8 },
            apocalypse: { name: 'Apocalypse', type: 'Attack', hp: 100, atk: 11, def: 6, sta: 7, spd: 7 }
        };

        const STORY_OPPONENTS = [
            { name: 'Rookie', bey: 'spryzen', level: 1 },
            { name: 'Trainer', bey: 'valtrak', level: 2 },
            { name: 'Master', bey: 'fafnir', level: 3 },
            { name: 'Legend', bey: 'phoenix', level: 4 },
            { name: 'CHAMPION', bey: 'apocalypse', level: 5 }
        ];

        const app = {
            // Game state
            mode: null,
            isAI: false,
            storyLevel: 0,

            p1: { name: '', bey: null, hp: 0, maxHp: 0, sta: 0, maxSta: 0, bursts: 0, launched: false, x: 0, y: 0, vx: 0, vy: 0, angle: 0, angularVel: 0, lastCollisionTime: 0, atk: 0, def: 0, spd: 0 },
            p2: { name: '', bey: null, hp: 0, maxHp: 0, sta: 0, maxSta: 0, bursts: 0, launched: false, x: 0, y: 0, vx: 0, vy: 0, angle: 0, angularVel: 0, lastCollisionTime: 0, atk: 0, def: 0, spd: 0 },

            gameActive: false,
            bothLaunched: false,
            stadiumRadius: 180,

            // Screen management
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            startPvp() {
                this.mode = 'pvp';
                this.isAI = false;
                this.showScreen('setupScreen');
            },

            startStory() {
                this.mode = 'story';
                this.isAI = true;
                this.storyLevel = 0;
                this.p1.name = 'You';
                this.goToSelection();
            },

            startTraining() {
                this.mode = 'training';
                this.isAI = true;
                this.p1.name = 'You';
                this.p2.name = 'Training Bot';
                this.goToSelection();
            },

            goToSelection() {
                if (this.mode === 'pvp') {
                    const p1 = document.getElementById('blader1Name').value || 'Player 1';
                    const p2 = document.getElementById('blader2Name').value || 'Player 2';
                    this.p1.name = p1;
                    this.p2.name = p2;
                }

                this.populateSelection();
                this.showScreen('selectionScreen');
            },

            populateSelection() {
                const grid = document.getElementById('beyGrid');
                grid.innerHTML = '';

                Object.keys(BEYBLADES).forEach(key => {
                    const bey = BEYBLADES[key];
                    const option = document.createElement('div');
                    option.className = 'bey-option';

                    const canvas = document.createElement('canvas');
                    canvas.className = 'bey-canvas';
                    canvas.width = 80;
                    canvas.height = 80;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#222';
                    ctx.fillRect(0, 0, 80, 80);
                    drawBeyblade(ctx, key, 80);

                    option.appendChild(canvas);
                    option.innerHTML += `<div class="bey-label">${bey.name}</div>`;
                    option.onclick = () => this.selectBey(key, option);

                    grid.appendChild(option);
                });
            },

            selectBey(key, element) {
                document.querySelectorAll('.bey-option').forEach(e => e.classList.remove('selected'));
                element.classList.add('selected');

                if (!this.p1.bey) {
                    this.p1.bey = key;
                } else if (!this.p2.bey) {
                    this.p2.bey = key;
                    document.getElementById('startBtn').disabled = false;
                }
            },

            startBattle() {
                if (this.isAI && !this.p2.bey) {
                    const opp = STORY_OPPONENTS[this.storyLevel];
                    this.p2.name = opp.name;
                    this.p2.bey = opp.bey;
                }

                this.initBattle();
            },

            initBattle() {
                const beyData1 = BEYBLADES[this.p1.bey];
                const beyData2 = BEYBLADES[this.p2.bey];

                this.p1.hp = this.p1.maxHp = 100 + beyData1.hp * 2;
                this.p1.sta = this.p1.maxSta = 100 + beyData1.sta * 8;
                this.p1.bursts = 0;
                this.p1.atk = beyData1.atk;
                this.p1.def = beyData1.def;
                this.p1.spd = beyData1.spd;
                this.p1.launched = false;

                this.p2.hp = this.p2.maxHp = 100 + beyData2.hp * 2;
                this.p2.sta = this.p2.maxSta = 100 + beyData2.sta * 8;
                this.p2.bursts = 0;
                this.p2.atk = beyData2.atk;
                this.p2.def = beyData2.def;
                this.p2.spd = beyData2.spd;
                this.p2.launched = false;

                this.gameActive = false;
                this.bothLaunched = false;

                document.getElementById('p1Name').textContent = this.p1.name;
                document.getElementById('p1BeyName').textContent = beyData1.name;
                document.getElementById('p2Name').textContent = this.p2.name;
                document.getElementById('p2BeyName').textContent = beyData2.name;

                // Draw in launchers
                const p1Canvas = document.getElementById('p1LaunchCanvas');
                const p2Canvas = document.getElementById('p2LaunchCanvas');
                p1Canvas.width = 100;
                p1Canvas.height = 100;
                p2Canvas.width = 100;
                p2Canvas.height = 100;

                const p1Ctx = p1Canvas.getContext('2d');
                const p2Ctx = p2Canvas.getContext('2d');
                p1Ctx.fillStyle = '#222';
                p1Ctx.fillRect(0, 0, 100, 100);
                drawBeyblade(p1Ctx, this.p1.bey, 100);

                p2Ctx.fillStyle = '#222';
                p2Ctx.fillRect(0, 0, 100, 100);
                drawBeyblade(p2Ctx, this.p2.bey, 100);

                document.getElementById('p1LaunchBtn').disabled = false;
                document.getElementById('p2LaunchBtn').disabled = false;

                this.clearLog();
                this.addLog(`MATCH START: ${this.p1.name} vs ${this.p2.name}`, 'system');

                this.showScreen('battleScreen');
                this.updateUI();
            },

            launch(playerNum) {
                const isPlayer1 = playerNum === 1;
                const player = isPlayer1 ? this.p1 : this.p2;
                const beyData = BEYBLADES[player.bey];

                if (player.launched) return;
                player.launched = true;

                document.getElementById(isPlayer1 ? 'p1LaunchBtn' : 'p2LaunchBtn').disabled = true;
                document.getElementById(isPlayer1 ? 'p1LaunchStatus' : 'p2LaunchStatus').textContent = 'LAUNCHED';

                const angle = Math.random() * Math.PI * 2;
                const speed = 7 + beyData.spd * 0.7;

                player.x = 200 + Math.cos(angle) * 150;
                player.y = 200 + Math.sin(angle) * 150;
                player.vx = Math.cos(angle) * speed;
                player.vy = Math.sin(angle) * speed;
                player.angularVel = speed * 30;

                this.addLog(`${player.name} launched ${beyData.name}!`, 'system');

                if (this.p1.launched && this.p2.launched) {
                    this.bothLaunched = true;
                    this.startCountdown();
                } else if (this.isAI && !isPlayer1) {
                    setTimeout(() => this.launch(2), 1000 + Math.random() * 1000);
                }
            },

            startCountdown() {
                let count = 3;
                const vsText = document.getElementById('vsText');
                vsText.style.display = 'block';
                const interval = setInterval(() => {
                    vsText.textContent = count;
                    count--;
                    if (count < 0) {
                        clearInterval(interval);
                        vsText.style.display = 'none';
                        this.addLog('BEYBLADES COLLIDE!', 'system');
                        this.gameActive = true;
                        this.animate();
                    }
                }, 1000);
            },

            animate() {
                const stadium = document.getElementById('battleStadium');
                const ctx = stadium.getContext('2d');

                ctx.clearRect(0, 0, 400, 400);

                // Draw stadium
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(200, 200, this.stadiumRadius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#ff6b00';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(200, 200, this.stadiumRadius, 0, Math.PI * 2);
                ctx.stroke();

                // Update physics
                this.updatePhysics();

                // Draw beyblades
                this.drawBey(ctx, this.p1);
                this.drawBey(ctx, this.p2);

                // Check collisions
                this.checkCollisions();
                this.checkStaminaLoss();

                if (this.gameActive) {
                    requestAnimationFrame(() => this.animate());
                }

                this.updateUI();
            },

            updatePhysics() {
                const update = (bey) => {
                    bey.vx *= 0.96;
                    bey.vy *= 0.96;
                    bey.angularVel *= 0.95;
                    bey.x += bey.vx;
                    bey.y += bey.vy;
                    bey.angle += bey.angularVel;

                    const speed = Math.sqrt(bey.vx ** 2 + bey.vy ** 2);
                    bey.sta -= speed * 0.5;

                    const dist = Math.sqrt((bey.x - 200) ** 2 + (bey.y - 200) ** 2);
                    if (dist > this.stadiumRadius) {
                        const angle = Math.atan2(bey.y - 200, bey.x - 200);
                        bey.x = 200 + Math.cos(angle) * this.stadiumRadius;
                        bey.y = 200 + Math.sin(angle) * this.stadiumRadius;
                        bey.vx *= -0.7;
                        bey.vy *= -0.7;
                    }

                    bey.sta = Math.max(0, bey.sta);
                };

                update(this.p1);
                update(this.p2);
            },

            drawBey(ctx, bey) {
                ctx.save();
                ctx.translate(bey.x, bey.y);
                ctx.rotate(bey.angle * Math.PI / 180);
                drawBeyblade(ctx, bey.bey, 50);
                ctx.restore();

                const speed = Math.sqrt(bey.vx ** 2 + bey.vy ** 2);
                if (speed < 0.5) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.4)';
                    ctx.beginPath();
                    ctx.arc(bey.x, bey.y, 30, 0, Math.PI * 2);
                    ctx.fill();
                }
            },

            checkCollisions() {
                const dx = this.p2.x - this.p1.x;
                const dy = this.p2.y - this.p1.y;
                const dist = Math.sqrt(dx ** 2 + dy ** 2);

                if (dist < 35 && Date.now() - this.p1.lastCollisionTime > 400) {
                    this.p1.lastCollisionTime = Date.now();
                    this.p2.lastCollisionTime = Date.now();

                    const beyData1 = BEYBLADES[this.p1.bey];
                    const beyData2 = BEYBLADES[this.p2.bey];

                    let dmg1 = beyData2.atk * 10 + Math.random() * 10;
                    let dmg2 = beyData1.atk * 10 + Math.random() * 10;

                    dmg1 *= (1 - (this.p1.def * 0.05));
                    dmg2 *= (1 - (this.p2.def * 0.05));

                    this.p1.hp -= dmg2;
                    this.p2.hp -= dmg1;

                    const angle = Math.atan2(dy, dx);
                    this.p1.vx -= Math.cos(angle) * 3;
                    this.p1.vy -= Math.sin(angle) * 3;
                    this.p2.vx += Math.cos(angle) * 3;
                    this.p2.vy += Math.sin(angle) * 3;

                    this.addLog(`üí• COLLISION! ${Math.ceil(dmg2)}/${Math.ceil(dmg1)} DMG`, 'collision');

                    if (this.p1.hp <= 0 && this.p1.bursts < 3) {
                        this.p1.bursts++;
                        this.p1.hp = this.p1.maxHp * 0.35;
                        this.addLog(`BURST BLOCKED! [${this.p1.bursts}/3]`, 'burst');
                    }
                    if (this.p2.hp <= 0 && this.p2.bursts < 3) {
                        this.p2.bursts++;
                        this.p2.hp = this.p2.maxHp * 0.35;
                        this.addLog(`BURST BLOCKED! [${this.p2.bursts}/3]`, 'burst');
                    }

                    this.checkEnd();
                }
            },

            checkStaminaLoss() {
                const checkPlayer = (player) => {
                    if (player.sta <= 0 && Math.sqrt(player.vx ** 2 + player.vy ** 2) < 0.3) {
                        return true;
                    }
                    return false;
                };

                if (checkPlayer(this.p1)) {
                    this.addLog(`${this.p1.name}'s beyblade STOPPED!`, 'system');
                    this.endBattle(2);
                }
                if (checkPlayer(this.p2)) {
                    this.addLog(`${this.p2.name}'s beyblade STOPPED!`, 'system');
                    this.endBattle(1);
                }
            },

            checkEnd() {
                if (this.p1.hp <= 0 && this.p1.bursts >= 3) {
                    this.endBattle(2);
                } else if (this.p2.hp <= 0 && this.p2.bursts >= 3) {
                    this.endBattle(1);
                }
            },

            endBattle(winner) {
                this.gameActive = false;
                const winnerName = winner === 1 ? this.p1.name : this.p2.name;

                document.getElementById('endTitle').textContent = `${winnerName.toUpperCase()} WINS!`;
                document.getElementById('endMessage').textContent = `Victory! ${winnerName} defeated ${winner === 1 ? this.p2.name : this.p1.name}!`;

                if (this.isAI && winner === 1 && this.storyLevel < STORY_OPPONENTS.length - 1) {
                    this.storyLevel++;
                    setTimeout(() => {
                        this.p1.bey = null;
                        this.p2.bey = null;
                        this.startBattle();
                    }, 3000);
                }

                this.showScreen('endScreen');
            },

            updateUI() {
                const updatePlayer = (num) => {
                    const player = num === 1 ? this.p1 : this.p2;
                    const hpPercent = Math.max(0, (player.hp / player.maxHp) * 100);
                    const staPercent = Math.max(0, (player.sta / player.maxSta) * 100);

                    document.getElementById(`p${num}HpBar`).style.width = hpPercent + '%';
                    document.getElementById(`p${num}StaminaBar`).style.width = staPercent + '%';

                    if (hpPercent < 30) {
                        document.getElementById(`p${num}HpBar`).classList.add('low');
                    } else {
                        document.getElementById(`p${num}HpBar`).classList.remove('low');
                    }

                    document.getElementById(`p${num}Stats`).textContent = `HP: ${Math.ceil(Math.max(0, player.hp))}/${player.maxHp} | STA: ${Math.ceil(Math.max(0, player.sta))}/${player.maxSta}`;

                    // Update burst icons
                    for (let i = 1; i <= 3; i++) {
                        const burst = document.getElementById(`p${num}Burst${i}`);
                        if (i <= player.bursts) {
                            burst.classList.add('blocked');
                        } else {
                            burst.classList.remove('blocked');
                        }
                    }
                };

                updatePlayer(1);
                updatePlayer(2);
            },

            clearLog() {
                document.getElementById('battleLog').innerHTML = '';
            },

            addLog(msg, type = 'system') {
                const log = document.getElementById('battleLog');
                const line = document.createElement('div');
                line.className = `log-line log-${type}`;
                line.textContent = msg;
                log.appendChild(line);
                log.scrollTop = log.scrollHeight;
            }
        };

        // Initialize app
        app.showScreen('menuScreen');
    </script>
</body>
</html>